<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>MÃ´ phá»ng CA â€“ Tráº¡m Thu PhÃ­ (NaSch Ä‘iá»u chá»‰nh)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:20px; }
    canvas { background:#222; display:block; margin:10px 0; }
    .controls { display:flex; gap:20px; flex-wrap:wrap; margin-top:10px; }
    .control { font-size:14px; }
    label { display:block; }
    .notes { background:#1c1c1c; padding:12px; border-left:4px solid #4dd0e1; margin-top:15px; font-size:14px; }
    .stats { margin-top:10px; font-size:14px; }
    .legend span { margin-right:15px; }
  </style>
</head>
<body>

<h2>MÃ´ phá»ng tráº¡m thu phÃ­ báº±ng Cellular Automata (NaSch Ä‘iá»u chá»‰nh)</h2>
<p>MÃ´ hÃ¬nh Nagelâ€“Schreckenberg Ä‘Æ°á»£c <b>Ä‘iá»u chá»‰nh</b>: má»—i bÆ°á»›c thá»i gian xe chá»‰ cÃ³ thá»ƒ <b>Ä‘i tá»‘i Ä‘a 1 Ã´</b>, váº­n tá»‘c Ä‘Æ°á»£c biá»ƒu diá»…n báº±ng <b>xÃ¡c suáº¥t di chuyá»ƒn</b>. CÃ¡ch nÃ y loáº¡i bá» hiá»‡n tÆ°á»£ng nháº£y qua tráº¡m vÃ  double service.</p>

<div class="legend">
  <span>ğŸŸ¦ Xe ETC</span>
  <span>ğŸŸ¨ Xe tráº£ tiá»n máº·t</span>
  <span>ğŸ”´ Buá»“ng thu phÃ­</span>
</div>

<canvas id="sim" width="900" height="360"></canvas>

<div class="stats">
  <div>â±ï¸ Thá»i gian: <span id="time">0</span> s</div>
  <div>ğŸš— Xe qua tráº¡m: <span id="passed">0</span></div>
  <div>ğŸ“ HÃ ng chá» (trÆ°á»›c booth): <span id="queue">0</span> xe</div>
</div>

<div class="controls">
  <div class="control">
    <label>ğŸš¦ LÆ°u lÆ°á»£ng vÃ o Î»: <span id="lval"></span></label>
    <input type="range" id="lambda" min="0.2" max="0.9" step="0.05" value="0.6">
  </div>

  <div class="control">
    <label>âš™ï¸ Gia tá»‘c / pháº£n á»©ng a: <span id="aval"></span></label>
    <input type="range" id="a" min="0.1" max="1" step="0.1" value="0.6">
  </div>

  <div class="control">
    <label>â± Mean service time Î¼ (s): <span id="muval"></span></label>
    <input type="range" id="mu" min="5" max="30" step="1" value="15">
  </div>

  <div class="control">
    <label>ğŸ§¾ Cháº¿ Ä‘á»™ T<sub>s</sub> (xe tiá»n máº·t)</label>
    <label><input type="radio" name="tsmode" value="fixed" checked> Cá»‘ Ä‘á»‹nh</label>
    <label><input type="radio" name="tsmode" value="exp"> PhÃ¢n phá»‘i mÅ©</label>
  </div>
</div>

<div class="notes">
<b>Giáº£i thÃ­ch:</b><br>
â€“ Má»—i Ã´ â‰ˆ 7.5m, má»—i bÆ°á»›c = 1 giÃ¢y.<br>
â€“ Xe chá»‰ cÃ³ thá»ƒ Ä‘i 0 hoáº·c 1 Ã´ má»—i bÆ°á»›c (v<sub>max</sub>=1).<br>
â€“ Gia tá»‘c a quyáº¿t Ä‘á»‹nh <i>xÃ¡c suáº¥t</i> xe Ä‘Æ°á»£c phÃ©p tiáº¿n lÃªn khi phÃ­a trÆ°á»›c trá»‘ng.<br>
â€“ Xe <b>tráº£ tiá»n máº·t</b> chá»‰ Ä‘Æ°á»£c phá»¥c vá»¥ khi Ä‘ang á»Ÿ Ä‘Ãºng buá»“ng thu phÃ­.<br>
â€“ T<sub>s</sub> cá»‘ Ä‘á»‹nh = Î¼ ; T<sub>s</sub> ngáº«u nhiÃªn ~ Exponential(mean = Î¼).
</div>

<script>
// ===== Tham sá»‘ cá»‘ Ä‘á»‹nh =====
const CELL = 10;
const ROWS = 6;
const COLS = 90;
const BOOTH_X = 50;

// ===== Tham sá»‘ Ä‘iá»u chá»‰nh =====
let lambda = 0.6;
let a = 0.6;
let mu = 15;
let serviceMode = 'fixed'; // 'fixed' | 'exp'

// ===== Tráº¡ng thÃ¡i =====
let grid = Array.from({ length: ROWS }, () => Array(COLS).fill(null));
let simTime = 0;
let passedCars = 0;

function newCar(type) {
  return {
    type: type,
    inService: false,
    service: 0,
    servedOnce: false
  };
}

// ===== Arrival =====
function spawn() {
  if (Math.random() < lambda) {
    const lane = Math.floor(Math.random() * 3);
    if (!grid[lane][0]) {
      grid[lane][0] = newCar(Math.random() < 0.6 ? 'ETC' : 'MANUAL');
    }
  }
}

// ===== Update =====
function step() {
  simTime++;
  spawn();

  for (let i = 0; i < ROWS; i++) {
    for (let x = COLS - 1; x >= 0; x--) {
      const car = grid[i][x];
      if (!car) continue;

      // ===== Logic thu phÃ­ xe tiá»n máº·t =====
      if (car.type === 'MANUAL') {
        if (x === BOOTH_X && !car.inService && !car.servedOnce) {
          car.inService = true;
          car.service = serviceMode === 'fixed'
            ? mu
            : Math.ceil(-mu * Math.log(1 - Math.random()));
        }

        if (car.inService) {
          car.service--;
          if (car.service <= 0) {
            car.inService = false;
            car.servedOnce = true;
          }
          continue;
        }
      }

      // ===== Quyáº¿t Ä‘á»‹nh di chuyá»ƒn (v_max = 1) =====
      const nextX = x + 1;
      if (nextX < COLS && !grid[i][nextX]) {
        const pMove = Math.min(1, a * 1.5);
        if (Math.random() < pMove) {
          grid[i][x] = null;
          if (nextX === COLS - 1) {
            passedCars++;
          } else {
            grid[i][nextX] = car;
          }
        }
      }
    }
  }
}

// ===== Draw =====
const ctx = document.getElementById('sim').getContext('2d');
function draw() {
  ctx.clearRect(0, 0, 900, 360);

  ctx.strokeStyle = 'red';
  ctx.beginPath();
  ctx.moveTo(BOOTH_X * CELL, 0);
  ctx.lineTo(BOOTH_X * CELL, ROWS * CELL);
  ctx.stroke();

  for (let i = 0; i < ROWS; i++) {
    for (let x = 0; x < COLS; x++) {
      const car = grid[i][x];
      if (!car) continue;
      ctx.fillStyle = car.type === 'ETC' ? '#4dd0e1' : '#ffca28';
      ctx.fillRect(x * CELL, i * CELL, CELL - 1, CELL - 1);
    }
  }
}

// ===== UI =====
const lslider = document.getElementById('lambda');
const aslider = document.getElementById('a');
const muslider = document.getElementById('mu');
const radios = document.getElementsByName('tsmode');

lslider.oninput = () => lambda = +lslider.value;
aslider.oninput = () => a = +aslider.value;
muslider.oninput = () => mu = +muslider.value;
radios.forEach(r => r.onchange = () => serviceMode = r.value);

function updateUI() {
  lval.textContent = lambda;
  aval.textContent = a;
  muval.textContent = mu;
  time.textContent = simTime;
  passed.textContent = passedCars;

  let q = 0;
  for (let i = 0; i < ROWS; i++) if (grid[i][BOOTH_X - 1]) q++;
  queue.textContent = q;
}

setInterval(() => {
  step();
  draw();
  updateUI();
}, 200);
</script>

</body>
</html>
